import pandas as pd
import numpy as np
import csv
from tqdm import tqdm
import fastai
from fastai.tabular import *
from sklearn.metrics import roc_auc_score


path = 'data/'

counter = 0
rowsLeft = 7853253

with open('data/submission.csv', 'w') as writer:
    writer.write('MachineIdentifier,HasDetections' + os.linesep)

while rowsLeft > 0:
    numToProcess = 1000000
    test_df = pd.read_csv("data/3_test_dates.csv", header=0, skiprows=range(counter * numToProcess + 1, (counter+1)*numToProcess), nrows=numToProcess)

    print("Number of records loaded:", len(test_df))

    data = TabularList.from_df(test_df)
    learner = load_learner(path, test=data)

    preds,y = learner.get_preds(ds_type=DatasetType.Test)

    with open('data/submission.csv', 'a') as writer:
        print("Number of predictions: ", len(preds))
        for i in range(len(preds)):
            hasDetection = preds[i][1].numpy()
            #print(test_df.loc[i]['MachineIdentifier'], hasDetection)
            writer.write(str(test_df.loc[i]['MachineIdentifier']) + "," + str(hasDetection) + os.linesep)


    counter = counter + 1
    rowsLeft = rowsLeft - numToProcess
    print("Rows left", rowsLeft)

# print("Preds", preds[0])
# print("Predict test_df[0]", learner.predict(test_df.iloc[0]))
