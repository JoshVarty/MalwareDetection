import pandas as pd
import numpy as np
import csv
from tqdm import tqdm
import fastai
from fastai.tabular import *
from sklearn.metrics import roc_auc_score

path = 'data/'

offset = 0
counter = 0
maxRows = 7853254
rowsLeft = maxRows

with open('data/submission.csv', 'w') as writer:
    writer.write('MachineIdentifier,HasDetections' + os.linesep)

for chunk in pd.read_csv("data/4_train_features.csv", chunksize=5000000):
    test_df = chunk

    print("Number of records loaded:", len(test_df))

    data = TabularList.from_df(test_df)
    learner = load_learner(path, test=data) 

    preds,y = learner.get_preds(ds_type=DatasetType.Test)

    with open('data/submission.csv', 'a') as writer:
        print("Number of predictions: ", len(preds))
        for i in range(len(preds)):
            hasDetection = preds[i][1].numpy()
            #print(test_df.loc[i]['MachineIdentifier'], hasDetection)
            writer.write(str(test_df.iloc[i]['MachineIdentifier']))
            writer.write(",")
            writer.write(str(hasDetection))
            writer.write(os.linesep)

    counter = counter + 1
    rowsLeft = rowsLeft - 1000000
    offset = offset + (counter * len(test_df))
    print("Rows left", rowsLeft)
